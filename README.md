# WSP Sniper CLI

[![Python](https://img.shields.io/badge/python-3.10%2B-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Code Style: Black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)

> The missing high-precision registration tool

Высокопроизводительный асинхронный бот для регистрации на дисциплины в системе WSP (KBTU). Стандартная регистрация через браузер часто страдает от задержек, ошибок сети и медленного интерфейса. Монолитные скрипты сложно поддерживать и настраивать.

**WSP Sniper** заполняет этот пробел: это модульное, отказоустойчивое решение на Python. Настройте свои предметы заранее, синхронизируйте время с точностью до миллисекунд и выполните регистрацию быстрее, чем прогрузится веб-страница.

## Особенности

- **Высокая скорость**: Использование `aiohttp` для мгновенных асинхронных запросов.
- **Отказоустойчивость**: Умная система ретраев (`tenacity`) при ошибках сети или 500-х ответах.
- **Интерактивный UI**: Удобный выбор предметов через консоль (`rich`), таблицы и цветные логи.
- **Умная автоматизация**:
  - Автоматическая конвертация вашего локального времени в UTC.
  - Сохранение выбранных предметов (пресетов) для следующих запусков.
  - Защита от бана: настраиваемые задержки между запросами.
- **Модульная архитектура**: Чистый код, разделенный на слои (API, Core, UI, Config).

## Установка

Проект оптимизирован для запуска через современный менеджер пакетов `uv`, но работает и через стандартный `pip`.

### Через uv (Рекомендуется)

Если у вас еще нет uv, установите его (одна команда):
```bash
# MacOS / Linux
curl -LsSf https://astral.sh/uv/install.sh | sh

# Windows
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
```

Затем клонируйте репозиторий и запустите:

```bash
git clone https://github.com/your-username/WSP-Sniper.git
cd wsp_sniper_cli
uv run main.py
```
*Вам не нужно создавать виртуальное окружение вручную — `uv` сделает это автоматически.*

### Через стандартный pip

```bash
git clone https://github.com/your-username/WSP-Sniper.git
cd wsp_sniper_cli
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -r requirements.txt
python main.py
```

## Использование

### Первый запуск (Мастер настройки)

При первом запуске `uv run main.py` бот автоматически определит отсутствие конфигурации и запустит интерактивный мастер:

1.  Введите **Username** и **Password** от WSP.
2.  Введите **Желаемое время старта** в вашем *локальном* времени (например, `10:00:00.000000`).
3.  Бот создаст файл `.env` и продолжит работу.

### Процесс регистрации

```text
1. [Login]       -> Авторизация в системе.
2. [Selection]   -> Вы выбираете предметы, потоки и группы (L/P).
                    * Бот проверит формулу (L1/Lb0/P1).
                    * Выбор сохранится в saved_plan.json.
3. [Waiting]     -> Синхронизация с NTP серверами и ожидание времени Ч.
4. [Snipe]       -> В 10:00:00 бот начнет отправку запросов.
```

### Повторный запуск

В следующий раз бот предложит загрузить прошлую конфигурацию:
```text
[?] Found a saved plan in 'saved_plan.json'.
Do you want to load the previous configuration? [y/n]
```

## Конфигурация (.env)

Для тонкой настройки поведения бота отредактируйте файл `.env`, созданный после первого запуска.

| Переменная | Описание | Дефолт |
|------------|----------|--------|
| `WSP_USERNAME` | Ваш логин | - |
| `WSP_PASSWORD` | Ваш пароль | - |
| `WSP_DESIRED_TIME_LOCAL` | Время старта (локальное). Бот сам переведет в UTC. | `10:00:00` |
| `WSP_REQUEST_DELAY` | Задержка (сек) между запросами на **разные** предметы. Помогает избежать ошибки 500 из-за перегрузки. | `0.5` |
| `WSP_RETRY_DELAY` | Задержка (сек) перед повтором, если сервер ответил **"Регистрация не началась"**. | `0.5` |

## Разработка

### Структура проекта

```
wsp_sniper_cli/
├── config/
│   ├── settings.py         # Загрузка переменных окружения (Pydantic)
│   └── setup.py            # Мастер первоначальной настройки
├── src/
│   ├── api/                # Клиент aiohttp и логика повторных запросов
│   ├── core/               # Бизнес-логика (валидация, планировщик)
│   ├── ui/                 # CLI интерфейс (таблицы, меню)
│   └── utils/              # Логирование и хелперы
├── saved_plan.json         # Автосохранение выбора пользователя
├── main.py                 # Точка входа
└── README.md
```

### Как работает Sniper Logic

1.  **NTP Sync**: Бот вычисляет разницу (offset) между временем вашей машины и точным временем интернета.
2.  **Busy Wait**: За секунду до старта бот переходит в режим активного ожидания (busy loop) для максимальной точности.
3.  **Staggered Launch**: Запросы отправляются не одновременно (что может убить соединение), а с крошечной задержкой `WSP_REQUEST_DELAY`.
4.  **Smart Retry**: Если запрос ушел слишком рано, бот не падает, а ждет `WSP_RETRY_DELAY` и пробует снова, пока не получит `200 OK`.

## Disclaimer

Этот проект разработан исключительно в образовательных целях для демонстрации возможностей Python (asyncio, aiohttp). Автор не несет ответственности за использование данного ПО, возможные сбои в работе университетской системы или дисциплинарные взыскания.

Используйте на свой страх и риск.

## License

MIT